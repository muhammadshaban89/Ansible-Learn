Overview:
---------
**This document contains details about ansible architecture, ansible instalation , ansible inventories, ansible configuration file and management**

Ansible Architecture:
------------------------------------

* There are two types of machines in ansible architecture:

* 1: Control Nodes: 
	-  Ansible is installed and run from control  nodes.
	- Control nodes should be linux or Unix systems.
	- Microsoft windows is not supported as Maneged hosts.
   	-  It also has coppies of you ansible project files.
	-  A control node could be an administrator,s laptop, a system shared by number of admininstrators or a server running RedHat Ansible Tower.
	
* 2: Managed Hosts:
 	- Are nodes managed by control nodes.
	- These could be windows, linux or cloud-based nodes or network devoces such as router & switches.
	- Managed hosts are listed in a file on control nodes called inventory.
	- In inventory you can list managed hosts as group for easier collective management.
	- Inventory files can be static or dynamic.
	- Dynamic inventories are determined by scripts that get info from external sources.
	- Ansible includes number of modules for managed hosts.
	- For windows managed hosts special modules are available.
	- Most of modules designed for windows managed hosts required powershell 3.0 or later , also require .NET Framework 4.0 or later to intall on windows managed hosts.
	- Ansible also includes number of modules for Network devices managed hosts.
	- Becuse of of Network devices can not run python ,ansible run modules on control nodes and then special connections methods are used to communicate with network devices, like CLI over SSH, XML over SSH or API over HTTP(s).

Installing Ansible:
------------------------------

- Ansible software needs to be installed on control  nodes from which you run ansible.
- Python3(3.5 or later) , python 2 (2.7) needs to be installed on the control nodes.
- If you have a Red Hat Ansible Engine subscription, the installation procedure for Red Hat Ansible Engine 2 is as follows:
	```bash
	[root@host ~]# subscription-manager register
	[root@host ~]# subscription-manager role --set="Red Hat Enterprise Linux Server"
	[root@host ~]# subscription-manager list --available
	[root@host ~]# subscription-manager attach --pool=<engine-subscription-pool>
	[root@host ~]# subscription-manager attach --pool=<engine-subscription-pool>
	[root@host ~]# yum install ansible
	
	```
- If you are using the version with limited support provided with your Red Hat Enterprise Linux subscription, use the following procedure:

1. Enable the Red Hat Ansible Engine repository.

	```
	[root@host ~]# subscription-manager register
	[root@host ~]# subscription-manager role --set="Red Hat Enterprise Linux Server"
	[root@host ~]# subscription-manager list --available
	[root@host ~]# subscription-manager attach --pool=<engine-subscription-pool>
	[root@host ~]# subscription-manager repos  --enable ansible-2-for-rhel-8-x86_64-rpms
	[root@host ~]# yum install ansible
	[root@host ~]# subscription-manager refresh
	[root@host ~]# subscription-manager repos  --enable ansible-2-for-rhel-8-x86_64-rpms

	```

Ansible Inventory:
-------------------------------
* An inventory defines a collection of host that ansible will manage.
*  In inventory you can list managed hosts as group for easier collective management.
*  Groups can c ontain child groups and host can be member of multiple groups.
* Host inventories can be define in two ways:
 	- Static Invenevtory: defined in text file.
	- Dynamic inventory: can be generated by script or other program as need, using external information providor.

How to specify managed hosts in static inventory?
------------------------------------------------

You can write in number of diffrent formates:
	- INI style      ---> most common
	- YAML file

Example:
```
web1.example.local
192.168.244.133
```
- For easier collective management , you can mention hosts in groups:
```
[webserver]
web1.example.local
192.68.100.10
web2-exaple.local

[database]
db1.example.local
db2.example.local
```

- You can also define nested groups , that are --> group of host groups:

Example:

```
[usa] 
washington1.example.com 
washington2.example.com

[canada]
ontario01.example.com 
ontario02.example.com

[north-america:children] 
canada
```
- A group can have both managed hosts and child group as members.
```
[north-america:children] 
canada
```
- You can specify ranges also:

   [start:end]

Example:
 ```
192.168.[2:7].10
```
this includes- hosts from 192.168.2.10  192.168.3.10  until 192.168.7.10 

web[a:f].example.local  -> includes--> weba.example.local untill webf.example.local

verify the inventory:
----------------------------------
- use Ansible command to verify the machine,s presence in inventory:
```
[user@controlnode ~]$ ansible washington1.example.com --list-hosts
```
- You can run the following command to list all hosts in a group:
```	
[user@controlnode ~]$ ansible canada --list-hosts
```	
Location of inventory file:
--------------------------------------------

 - default location of static inventory file is :
```
/etc/ansible/hosts
```
- you can define in the current working directory , but you have to use -i inventory switch:
```
[student@workstation deploy-inventory]$ ansible testing -i inventory  --list-hosts

```

Ansible Configuration file:
---------------------------------------------

* The ansible package provides a base configuration file located at /etc/ansible/ansible.cfg. 
* This file is used if no other configuration file is found.

Ansible configuration file precedence:
Ansible will use configuration file in following precedence.

- 1:  location specified in  ANSIBLE_CONFIG environment variable.
- 2: Current working directory.   
- 3: user home directory.   ~/.ansible.cfg
- 4: default location /etc/ansible/ansible.cfg

Note:
--------
* The recommended practice is to create an ansible.cfg file in a directory from which you run Ansible commands. 
* This directory would also contain any files used by your Ansible project, such as an inventory and a playbook. 
* This is the most common location used for the Ansible configuration file.
*  It is unusual to use a ~/.ansible.cfg or /etc/ansible/ansible.cfg file in practice.

* You can run the `ansible --version` command to clearly identify which version of Ansible is installed, and which configuration file is being used.

```
[user@controlnode ~]$ ansible --version
```

OR

```
[user@controlnode ~]$ ansible servers --list-hosts -v

```

How to manage settings in configuration file?
-----------------------------------------------------------------------------

* The Ansible coniguration consist of several sections wich each section consist of key-value pairs.
* for basic operations use following two sections:

- 1: [defaults]      --> set defaults for ansible.
- 2: [privilege_escalation]  --> configures how ansible performs privilege escalations on managed hosts.


```

[defaults]
inventory = ./inventory
remote_user = user 
ask_pass = false

[privilege_escalation] 
become = true 
become_method = sudo 
become_user = root 
become_ask_pass = false

```
Explaining all options:

* inventory  => Specifies the path to the inventory file.
* remote_user => The name of the user to log in as on the managed hosts. If not specified, the current user's name is used
* ask_pass => Whether or not to prompt for an SSH password. Can be
false if using SSH public key authentication.
* become => Whether to automatically switch user on the managed host (typically to root) after connecting. This can also be specified by a play
* become_method => How to switch user (typically sudo, which is the default, but su is an option).
* become_user =>The user to switch to on the managed host (typically root, which is the default)
* become_ask_pass =>Whether to prompt for a password for your become_method. Defaults to false.


-  By default, Ansible connects to managed hosts using the SSH protocol.
-  The most important parameters that control how Ansible connects to the managed hosts are set in the [defaults] section.
- By default, Ansible attempts to connect to the managed host using the same user name as the local user running the Ansible commands. 
- To specify a different remote user, set the `remote_user` parameter to that user name.




Non-SSH Connections:
--------------------------------------

- The protocol used by Ansible to connect to managed hosts is set by default to "smart", which determines the most efficient way to use SSH. 

- This can be set to other values in a number of ways.
For example, there is one exception to the rule that SSH is used by default. If you do not have localhost in your inventory, Ansible sets up an implicit localhost entry to allow you to run ad hoc commands and playbooks that target localhost. T
- This special inventory entry is not included in the "all" or "ungrouped" host groups.
-  In addition, instead of using the "smart SSH" connection type, Ansible connects to it using the special "local" connection type by default.

```
[user@controlnode ~]$ ansible localhost --list-hosts
```
- The "local" connection type ignores the remote_user setting and runs commands directly on the local system. If privilege escalation is being used, it runs sudo from the user account that ran the Ansible command, not remote_user. 
- This can lead to confusion if the two users have different sudo privileges.
- If you want to make sure that you connect to localhost using SSH like other managed hosts, one approach is to list it in your inventory. But, this includes it in the all and ungrouped groups, which you may not want to do.
- Another approach is to change the protocol used to connect to localhost. The best way to do this is to set the "ansible_connection" host variable for localhost.
- To do this, in the directory from which you run Ansible commands, create a "host_vars" subdirectory. In that subdirectory, create a file named "localhost", containing the line "ansible_connection: smart". This ensures that the smart (SSH) connection protocol is used instead of local for localhost.

- You can use this the other way around as well. If you have 127.0.0.1 listed in your inventory, by default you will connect to it using smart. You can also create a "host_vars/127.0.0.1" file containing the line "ansible_connection: local" and it will use local instead.




CONFIGURATION FILE COMMENTS:
------------------------------------------------------------

- There are two comment characters allowed by Ansible configuration files: the hash or number sign (#) and the semicolon (;).

- The number sign at the start of a line comments out the entire line. It must not be on the same line with a directive.

- The semicolon character comments out everything to the right of it on the line. It can be on the same line as a directive, as long as that directive is to its left.
